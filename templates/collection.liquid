<div id="col-main" class="{{ collection.handle }}">
  <br>
    <div class='options row'>
      <ul class='option-set large-3 columns' id='sort-filters' data-option-key='sortBy'>
        <li><a href='#options' class='option-value' data-option-value='percent'></a> Percent</li>
        <li><a href='#options' class='option-value' data-option-value='popularity'></a> Popularity</li>
      </ul>
      <ul class='option-set large-3 columns' id='batch-filters' data-option-key='filter'>
        <li><a href='#options' class='option-value' data-option-value='.artisan'></a> Small-batch</li>
        <li><a href='#options' class='option-value' data-option-value='*'></a> Large-batch</li>
      </ul>
      <ul class='option-set large-6 columns' id='region-filters' data-option-key='filter'>
        <li><a href='#options' class='option-value' data-option-value='.NE'></a> Northeast</li>
        <li><a href='#options' class='option-value' data-option-value='.SE'></a> Southeast</li>
        <li><a href='#options' class='option-value' data-option-value='.NW'></a> Northwest</li>
        <li><a href='#options' class='option-value' data-option-value='.SW'></a> Southwest</li>
        <li><a href='#options' class='option-value' data-option-value='.MW'></a> Midwest</li>
      </ul>
    </div>

    {% paginate collection.products by 100 %}
      {% if collection.products.size > 0 %}
    
        <div class="product-grid clearfix isotope">
          {% for product in collection.products %}
            <div class='item {{ product.metafields.image.orientation }} {% for tag in product.tags %} {{tag}} {% endfor %}'>
              {% include 'product-grid-item' %}
            </div>
          {% endfor %}
        </div>

        {% include 'pagination' %}
      
      {% else %}    
        <strong>No products found in this collection.</strong>
      {% endif %}
    {% endpaginate %}
  </section>
  
</div> <!-- /#col-main -->

<script type="text/javascript">
  $(function(){
    $('.product-grid').isotope({
      itemSelector :'.item',
      masonry: {
        columnWidth: 1
      },
      getSortData : {
        percent : function ( $elem ) {
          return $elem.attr('data-percent');
        }
      }
    });
  });

  $('.product-grid-item').hover(function(){
    var prod_handle = $(this)[0].getAttribute('data-product');
    var prod_url = $(this)[0].getAttribute('data-url');
    var $item_holder = $(this)

    $item_holder.css('background-color', 'black');
    $item_holder.css('opacity', 0.3);
    $item_holder.html('<span style="position:absolute;padding-top:'+$item_holder.height()/2+'px;padding-left:'+$item_holder.width()/2+'px;left:-15px;top:-15px;"><a href="'+prod_url+'?quantity=5">{{ "fancy_close.png" | asset_url | img_tag }}</a></span>');
  }).mouseleave(function(){
      $(this).css('background-color', 'black');
      $(this).css('opacity', 1);
      $(this).html(''); //destroys product right now
  })

  // if a filter is clicked
  // register which filters are active
  // make sure whatever product is on the page has that tag
  // repopulate page and masonry-ize it

  $option_values = $('.options a');
  var options_hash = new HashTable({});
  var filters = [];
  var sorters = [];

  // if any of the filters are clicked
  $option_values.click(function(){ 
    // find out if it's a filter or a sorter
    $option_key = $(this).parent().parent();

    /////
    // REMOVE
    /////
    // if it's already been clicked, unselect it and remove it from the Hash
    if($(this).hasClass('selected')){
      $(this).removeClass('selected');
      $(this).css('background-color', 'white')

      // if a filter has been clicked
      if ($option_key.attr('data-option-key')=='filter'){
        value_index = filters.indexOf($(this).attr('data-option-value'));
        filters.splice(value_index,1);

        var filter_string = getFilterString(filters);

        options_hash.setItem($option_key.attr('data-option-key'), filter_string);
      }
      else{ // if a sorter has been clicked
        $(this).parent()
        options_hash.removeItem($option_key.attr('data-option-key'));
        options_hash.removeItem('sortAscending');
      }
    }
    else { 
      /////
      //  ADD
      /////
      // if it hasn't been clicked, select it and add it to the Hash
      $(this).addClass('selected');
      $(this).css('background-color', 'black')
      if ($option_key.attr('data-option-key')=='filter'){
        filters.push($(this).attr('data-option-value'))
        var filter_string = getFilterString(filters);

        console.log('filter clicked ' + filter_string)

        options_hash.setItem($option_key.attr('data-option-key'), filter_string);
      }
      else {
        options_hash.setItem($option_key.attr('data-option-key'), $(this).attr('data-option-value'));
        options_hash.setItem('sortAscending', false);
      }
    }
    // run the filter/sorter and reload the grid
      var values = options_hash.values();
      console.log(values)
      var keys = options_hash.keys();
      console.log(keys)
      $.each(values, function(i,v){
        console.log('key ' + keys[i] + ' value ' + v)
        var options = {};
        options[keys[i]] = v;
        $('.product-grid').isotope(options)
    });
  })

  // Functions

  function getFilterString(filters) {
    var hold_filters = '';
    $.each(filters, function(i,v) {
      hold_filters = hold_filters +' '+ v;
    })
    return hold_filters;
  }


  // Classes 

  function HashTable(obj)
  {
    this.length = 0;
    this.items = {};
    for (var p in obj) {
        if (obj.hasOwnProperty(p)) {
            this.items[p] = obj[p];
            this.length++;
        }
    }

    this.setItem = function(key, value)
    {
        var previous = undefined;
        if (this.hasItem(key)) {
            previous = this.items[key];
        }
        else {
            this.length++;
        }
        this.items[key] = value;
        return previous;
    }

    this.getItem = function(key) {
        return this.hasItem(key) ? this.items[key] : undefined;
    }

    this.hasItem = function(key)
    {
        return this.items.hasOwnProperty(key);
    }
   
    this.removeItem = function(key)
    {
        if (this.hasItem(key)) {
            previous = this.items[key];
            this.length--;
            delete this.items[key];
            return previous;
        }
        else {
            return undefined;
        }
    }

    this.keys = function()
    {
        var keys = [];
        for (var k in this.items) {
            if (this.hasItem(k)) {
                keys.push(k);
            }
        }
        return keys;
    }

    this.values = function()
    {
        var values = [];
        for (var k in this.items) {
            if (this.hasItem(k)) {
                values.push(this.items[k]);
            }
        }
        return values;
    }

    this.each = function(fn) {
        for (var k in this.items) {
            if (this.hasItem(k)) {
                fn(k, this.items[k]);
            }
        }
    }

    this.clear = function()
    {
        this.items = {}
        this.length = 0;
    }
  }
</script>